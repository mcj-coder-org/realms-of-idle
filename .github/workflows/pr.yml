name: Pull Request Management

on:
  pull_request:
    types: [opened, closed, synchronize, labeled]

permissions:
  contents: read
  issues: write

env:
  NODE_VERSION: '22'

jobs:
  pr-quality-check:
    runs-on: ubuntu-latest
    name: PR Quality Check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check if issue reference exists
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const issueMatch = prTitle.match(/#\d+/);

            if (!issueMatch) {
              core.setFailed('PR title must include issue reference (e.g., "#123").');
              return;
            }

            const issueNumber = issueMatch[0].substring(1);
            console.log(`Checking issue #${issueNumber}...`);

            // Fetch issue details
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber)
            });

            if (issue.data.state === 'closed') {
              core.setFailed(`Issue #${issueNumber} is already closed.`);
              return;
            }

            console.log(`Issue #${issueNumber} is open.`);

  pr-enforcement:
    runs-on: ubuntu-latest
    name: PR Enforcement
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: Check for conventional commit
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const conventionalRegex = /^(feat|fix|docs|refactor|test|chore)(\(.*\))?!?: .+#\d+/;

            if (!conventionalRegex.test(prTitle)) {
              core.setFailed('PR title must follow conventional commits format and include issue reference (e.g., "feat(module): add feature #123").');
              return;
            }

            console.log('âœ… Conventional commit format verified');

  pr-labels:
    runs-on: ubuntu-latest
    name: Auto-label PRs
    if: github.event_name == 'pull_request'
    continue-on-error: true
    steps:
      - name: Apply labels based on files changed
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // Fetch files via GitHub API
            const result = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const files = result.data;

            const labels = new Set();

            for (const file of files) {
              const filename = file.filename.toLowerCase();

              if (filename.includes('test') || filename.includes('.spec.') || filename.includes('.test.')) {
                labels.add('test');
              }

              if (filename.includes('docs') || filename.includes('md') || filename.includes('readme')) {
                labels.add('documentation');
              }

              if (filename.includes('config') || filename.includes('build') || filename.includes('ci')) {
                labels.add('ci');
              }

              if (filename.includes('src') && (filename.includes('component') || filename.includes('ui') || filename.includes('style'))) {
                labels.add('ui');
              }

              if (filename.includes('security') || filename.includes('auth') || filename.includes('secret')) {
                labels.add('security');
              }
            }

            if (files.length > 50) {
              labels.add('large-pr');
            }

            if (labels.size > 0) {
              // Note: Auto-labeling disabled due to repository workflow permissions
              // Repository has default workflow permissions set to 'read'
              // To enable: Settings > Actions > General > Workflow permissions > Read and write
              console.log(`Would apply labels: ${Array.from(labels).join(', ')}`);
              // await github.rest.issues.addLabels({
              //   issue_number: prNumber,
              //   owner: context.repo.owner,
              //   repo: context.repo.repo,
              //   labels: Array.from(labels)
              // });
            } else {
              console.log('No labels to apply');
            }

  pr-comment:
    runs-on: ubuntu-latest
    name: Auto-comment on PR
    if: github.event.pull_request.merged && github.event.pull_request.base.ref == 'main'
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const author = context.payload.pull_request.user.login;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ‰ PR merged successfully! The deployment pipeline will run automatically to deploy to staging.

              - **PR**: #${prNumber}
              - **Title**: ${prTitle}
              - **Author**: @${author}
              - **Target**: Main branch â†’ Staging deployment

              The deployed application will be available at: https://staging.idle-world.com/

              ðŸš¨ Please verify the deployment works as expected before merging to production.`
            })
