name: Release

on:
  push:
    tags:
      - 'v*'
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  release:
    runs-on: ubuntu-latest
    name: Release
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Generate changelog
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const tagName = process.env.GITHUB_REF_NAME;
            const [major, minor, patch] = tagName.replace('v', '').split('.');

            // Get commits since last tag
            const commits = execSync(`git log --no-merges --oneline --reverse tags/v${major}.${minor}.${patch - 1 || 0}...${tagName}`).toString().trim();

            // Generate markdown
            let changelog = `## ${tagName}\n\n`;

            // Group commits by conventional commit type
            const commitsByType = {};
            commits.split('\n').forEach(commit => {
              const match = commit.match(/^([a-z]+)(?:\(([^)]+)\))?(!?):\s+(.+)$/);
              if (match) {
                const [, type, scope, breaking, message] = match;
                const key = type + (breaking ? '!' : '');
                if (!commitsByType[key]) commitsByType[key] = [];
                commitsByType[key].push(`- ${scope ? `**${scope}**: ` : ''}${message}`);
              }
            });

            // Add sections
            Object.entries(commitsByType).forEach(([type, messages]) => {
              const typeTitle = type === 'feat' ? 'Features' :
                                type === 'fix' ? 'Bug Fixes' :
                                type === 'docs' ? 'Documentation' :
                                type === 'refactor' ? 'Refactoring' :
                                type === 'test' ? 'Tests' :
                                type === 'chore' ? 'Chores' : 'Other Changes';
              changelog += `\n### ${typeTitle}\n\n${messages.join('\n')}\n`;
            });

            // Create release
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `Release ${tagName}`,
              body: changelog,
              draft: false,
              prerelease: false
            });

            console.log('Release created:', release);

  publish-npm:
    runs-on: ubuntu-latest
    name: Publish to NPM
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  release-notes:
    runs-on: ubuntu-latest
    name: Update release notes
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update issue template
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const tagName = process.env.GITHUB_REF_NAME;
            const parts = tagName.replace('v', '').split('.');
            const major = parts[0];
            const minor = parts[1];

            // Create new issue template for next version
            const nextVersion = `v${major}.${Number(minor) + 1}.0`;
            const template = `## Release ${nextVersion}

### Planned Features

- [ ] Feature 1
- [ ] Feature 2

### Bug Fixes

- [ ] Bug 1
- [ ] Bug 2

### Documentation

- [ ] Update X documentation
- [ ] Add Y examples

### Other Tasks

- [ ] Task 1
- [ ] Task 2

---

*Generated automatically for release ${nextVersion}*
`;

            // Update issue template file
            const fs = require('fs');
            fs.writeFileSync('.github/ISSUE_TEMPLATE/release.md', template);

            // Commit the change
            execSync('git config --global user.name "github-actions[bot]"');
            execSync('git config --global user.email "github-actions[bot]@users.noreply.github.com"');
            execSync('git add .github/ISSUE_TEMPLATE/release.md');
            execSync('git commit -m "docs: update release template for ${nextVersion}"');
            execSync('git push origin main');

            console.log('Release template updated for', nextVersion);
