@page "/"
@inject HttpGameService GameService
@inject ILogger<Home> Logger

<PageTitle>Realms of Idle - Web Client</PageTitle>

<div class="container">
    <h1>üéÆ Realms of Idle</h1>
    <p class="lead">Blazor WASM Web Client - Under Construction</p>

    @if (_isLoading)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">API Connection Status</h5>
                <p>
                    Status: @(_isHealthy ? "‚úÖ Connected" : "‚ùå Disconnected")
                </p>

                @if (_isHealthy)
                {
                    <button class="btn btn-primary me-2" @onclick="PerformClickAction">
                        Click (+1 Gold)
                    </button>

                    <button class="btn btn-secondary me-2" @onclick="PerformUpgradeAction">
                        Upgrade (Cost: 10)
                    </button>

                    <p class="mt-3">
                        <strong>Actions performed:</strong> @_actionCount
                    </p>
                }
                else
                {
                    <div class="alert alert-warning">
                        Unable to connect to game API. Make sure the server is running.
                    </div>
                }
            </div>
        </div>

        <div class="mt-4">
            <h5>Instructions</h5>
            <ul>
                <li>Start the server: <code>dotnet run --project src/RealmsOfIdle.AppHost</code></li>
                <li>API will be available at: <code>https://localhost:7001</code></li>
                <li>This client communicates via HTTP to the API</li>
            </ul>
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private bool _isHealthy = false;
    private int _actionCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await CheckApiHealthAsync();
        _isLoading = false;
    }

    private async Task CheckApiHealthAsync()
    {
        try
        {
            Logger.LogInformation("Checking API health...");
            _isHealthy = await GameService.CheckApiHealthAsync();
            Logger.LogInformation("API healthy: {IsHealthy}", _isHealthy);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to check API health");
            _isHealthy = false;
        }
    }

    private async Task PerformClickAction()
    {
        try
        {
            Logger.LogInformation("Performing click action");
            var success = await GameService.PerformActionAsync("player-1", "click");

            if (success)
            {
                _actionCount++;
                Logger.LogInformation("Click action succeeded. Total: {Count}", _actionCount);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Click action failed");
        }
    }

    private async Task PerformUpgradeAction()
    {
        try
        {
            Logger.LogInformation("Performing upgrade action");
            var success = await GameService.PerformActionAsync("player-1", "upgrade");

            if (success)
            {
                _actionCount++;
                Logger.LogInformation("Upgrade action succeeded. Total: {Count}", _actionCount);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Upgrade action failed");
        }
    }
}
