@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@using Microsoft.JSInterop

<button class="theme-switcher" @onclick="CycleTheme" title="Switch theme">
    <span class="theme-icon">@GetThemeIcon()</span>
</button>

@code {
    private IJSObjectReference? _module;
    private Theme _currentTheme = Theme.Color;

    [Parameter]
    public EventCallback<Theme> OnThemeChanged { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/RealmsOfIdle.Client.UI/js/theme-manager.js");
            _currentTheme = (Theme)(await _module.InvokeAsync<int>("getTheme"));
        }
    }

    private async Task CycleTheme()
    {
        if (_module is null) return;

        var newTheme = (Theme)(await _module.InvokeAsync<int>("cycleTheme"));
        _currentTheme = newTheme;

        await OnThemeChanged.InvokeAsync(newTheme);
    }

    private string GetThemeIcon()
    {
        return _currentTheme switch
        {
            Theme.Green => "ðŸŸ¢",
            Theme.Amber => "ðŸŸ ",
            _ => "ðŸŽ¨"
        };
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Browser is gone, ignore
            }
        }
    }
}
