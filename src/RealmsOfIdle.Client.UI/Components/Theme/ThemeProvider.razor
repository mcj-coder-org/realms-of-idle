@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@using Microsoft.JSInterop

@* Theme state provider - should wrap app content *@
@ChildContent

@code {
    private IJSObjectReference? _module;
    private Theme _currentTheme = Theme.Color;

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public EventCallback<Theme> OnThemeChanged { get; set; }

    /// <summary>
    /// Get the current theme
    /// </summary>
    public Theme CurrentTheme => _currentTheme;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/RealmsOfIdle.Client.UI/js/theme-manager.js");
            _currentTheme = (Theme)(await _module.InvokeAsync<int>("getTheme"));
        }
    }

    /// <summary>
    /// Set a specific theme
    /// </summary>
    public async Task SetThemeAsync(Theme theme)
    {
        if (_module is null) return;

        await _module.InvokeVoidAsync("setTheme", (int)theme);
        _currentTheme = theme;

        await OnThemeChanged.InvokeAsync(theme);
    }

    /// <summary>
    /// Cycle to the next theme
    /// </summary>
    public async Task CycleThemeAsync()
    {
        if (_module is null) return;

        var newTheme = (Theme)(await _module.InvokeAsync<int>("cycleTheme"));
        _currentTheme = newTheme;

        await OnThemeChanged.InvokeAsync(newTheme);
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Browser is gone, ignore
            }
        }
    }
}
