@inject IJSRuntime JSRuntime
@inject ILogger<ThemeProvider> Logger
@inject UiMetrics Metrics
@implements IAsyncDisposable
@using Microsoft.JSInterop
@using RealmsOfIdle.Client.UI.Components.Observability

@* Theme state provider - should wrap app content *@
@ChildContent

@code {
    private IJSObjectReference? _module;
    private Theme _currentTheme = Theme.Color;

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public EventCallback<Theme> OnThemeChanged { get; set; }

    /// <summary>
    /// Get the current theme
    /// </summary>
    public Theme CurrentTheme => _currentTheme;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/RealmsOfIdle.Client.UI/js/theme-manager.js");
            _currentTheme = (Theme)(await _module.InvokeAsync<int>("getTheme"));
            Logger.LogDebug("Theme provider initialized with theme: {Theme}", _currentTheme);
        }
    }

    /// <summary>
    /// Set a specific theme
    /// </summary>
    public async Task SetThemeAsync(Theme theme)
    {
        if (_module is null) return;

        var oldTheme = _currentTheme;
        await _module.InvokeVoidAsync("setTheme", (int)theme);
        _currentTheme = theme;

        Logger.LogDebug("Theme changed: {OldTheme} -> {NewTheme}", oldTheme, theme);
        Metrics.RecordThemeChange(oldTheme.ToString(), theme.ToString());

        await OnThemeChanged.InvokeAsync(theme);
    }

    /// <summary>
    /// Cycle to the next theme
    /// </summary>
    public async Task CycleThemeAsync()
    {
        if (_module is null) return;

        var oldTheme = _currentTheme;
        var newTheme = (Theme)(await _module.InvokeAsync<int>("cycleTheme"));
        _currentTheme = newTheme;

        Logger.LogDebug("Theme cycled: {OldTheme} -> {NewTheme}", oldTheme, newTheme);
        Metrics.RecordThemeChange(oldTheme.ToString(), newTheme.ToString());

        await OnThemeChanged.InvokeAsync(newTheme);
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Browser is gone, ignore
            }
        }
    }
}
