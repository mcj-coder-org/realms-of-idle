@inject IJSRuntime JSRuntime
@inject ILogger<GameHud> Logger
@inject UiMetrics Metrics
@implements IAsyncDisposable
@using RealmsOfIdle.Client.UI.Components.Observability

<div class="game-hud">
    <!-- Top HUD -->
    <TopHud PlayerStats="@PlayerStats" ShowInnLevel="@ShowInnLevel" ShowHealth="@ShowHealth" />

    <!-- Help Panel -->
    <HelpPanel ControlHints="@ControlHints" ShowTitle="@ShowHelpTitle" />

    <!-- Main Content Slot -->
    @if (ChildContent is not null)
    {
        @ChildContent
    }

    <!-- Info Panel (floating) -->
    <InfoPanel
        Content="@InfoContent"
        IsVisible="@ShowInfoPanel"
        Position="@InfoPanelPosition"
        OnClose="CloseInfoPanel"
        OnAction="HandleInfoPanelAction" />

    <!-- Action Bar -->
    <ActionBar ActionSlots="@ActionSlots" OnAction="HandleQuickAction" />
</div>

@code {
    [Parameter]
    public PlayerStats PlayerStats { get; set; } = new()
    {
        Gold = 0,
        PlayerLevel = 1,
        InnLevel = 1,
        Health = 100,
        MaxHealth = 100
    };

    [Parameter]
    public bool ShowInnLevel { get; set; } = true;

    [Parameter]
    public bool ShowHealth { get; set; } = true;

    [Parameter]
    public bool ShowHelpTitle { get; set; } = true;

    [Parameter]
    public IReadOnlyList<QuickActionSlot> ActionSlots { get; set; } = GetDefaultActionSlots();

    [Parameter]
    public IReadOnlyList<ControlHint> ControlHints { get; set; } = Array.Empty<ControlHint>();

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public EventCallback<string> OnQuickAction { get; set; }

    [Parameter]
    public EventCallback<string> OnInfoPanelAction { get; set; }

    // Info panel state
    private InfoPanelContent? InfoContent { get; set; }
    private bool ShowInfoPanel { get; set; }
    private (double X, double Y)? InfoPanelPosition { get; set; }

    private static IReadOnlyList<QuickActionSlot> GetDefaultActionSlots() =>
        new List<QuickActionSlot>
        {
            new() { Id = "focus", Label = "Focus", Icon = "üéØ", KeyHint = "1", IsActive = false },
            new() { Id = "interact", Label = "Interact", Icon = "‚úã", KeyHint = "2", IsActive = false },
            new() { Id = "talk", Label = "Talk", Icon = "üí¨", KeyHint = "3", IsActive = false },
            new() { Id = "inventory", Label = "Inventory", Icon = "üéí", KeyHint = "4", IsActive = false },
            new() { Id = "map", Label = "Map", Icon = "üó∫Ô∏è", KeyHint = "5", IsActive = false }
        };

    /// <summary>
    /// Show info panel at the specified position
    /// </summary>
    public void ShowInfo(InfoPanelContent content, double x, double y)
    {
        InfoContent = content;
        InfoPanelPosition = GetClampedPosition(x, y);
        ShowInfoPanel = true;

        Logger.LogDebug("Info panel shown: {Title} at ({X}, {Y})", content.Title, x, y);
        Metrics.RecordPanelView("info");

        StateHasChanged();
    }

    /// <summary>
    /// Hide info panel
    /// </summary>
    public void HideInfo()
    {
        ShowInfoPanel = false;
        Logger.LogDebug("Info panel hidden");
        StateHasChanged();
    }

    private void CloseInfoPanel()
    {
        Logger.LogDebug("Info panel closed by user");
        HideInfo();
    }

    private async Task HandleQuickAction(string actionId)
    {
        Logger.LogDebug("Quick action activated: {ActionId}", actionId);
        Metrics.RecordQuickAction(actionId);

        await OnQuickAction.InvokeAsync(actionId);
    }

    private async Task HandleInfoPanelAction(string actionId)
    {
        Logger.LogDebug("Info panel action clicked: {ActionId}", actionId);
        Metrics.RecordElementClick("info_panel_action", actionId);

        await OnInfoPanelAction.InvokeAsync(actionId);
    }

    private (double X, double Y) GetClampedPosition(double x, double y)
    {
        // Default info panel size (approximate)
        const double panelWidth = 300;
        const double panelHeight = 200;
        const double margin = 16;

        // Clamp X position
        if (x + panelWidth > WindowWidth - margin)
        {
            x = WindowWidth - panelWidth - margin;
        }
        if (x < margin)
        {
            x = margin;
        }

        // Clamp Y position
        if (y + panelHeight > WindowHeight - margin)
        {
            y = WindowHeight - panelHeight - margin;
        }
        if (y < margin + 60) // Account for top HUD
        {
            y = margin + 60;
        }

        return (x, y);
    }

    private double WindowWidth => 1920; // TODO: Get from JS interop
    private double WindowHeight => 1080; // TODO: Get from JS interop

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        // Cleanup when needed
    }
}
