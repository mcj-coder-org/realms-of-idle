#!/bin/sh
# Prevent commits directly to main — use feature branches
branch="$(git rev-parse --abbrev-ref HEAD)"
if [ "$branch" = "main" ]; then
  echo "❌ Direct commits to main are not allowed. Use a feature branch."
  exit 1
fi

# Lint staged files (markdown, json, yaml)
npx lint-staged

# Run fast tests if .cs files are staged
# Categories: Unit, System, Simulation, Architecture
if git diff --cached --name-only | grep -q '\.cs$'; then
  echo "Running .NET fast tests (Unit|System|Simulation|Architecture)..."
  dotnet test --filter "Category=Unit|Category=System|Category=Simulation|Category=Architecture" --no-build 2>/dev/null || dotnet test --filter "Category=Unit|Category=System|Category=Simulation|Category=Architecture"
fi

# Run unit tests if .ts files are staged
if git diff --cached --name-only | grep -q '\.ts$'; then
  echo "Running TypeScript unit tests..."
  npm test -- --run 2>&1 || echo "⚠️  No TS tests configured"
fi
